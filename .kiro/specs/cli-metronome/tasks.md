# Implementation Plan

- [x] 1. プロジェクト構造と GUI 依存関係の追加

  - GUI 関連クレート（egui、eframe、tokio）を Cargo.toml に追加
  - モジュール構造の拡張（gui モジュールの追加）
  - 既存の CLI 機能との互換性確保
  - _Requirements: 5.1, 5.2_

- [x] 2. データモデルの拡張と GUI エラーハンドリング

  - [x] 2.1 拍子とサウンドタイプの実装

    - TimeSignature enum（1/4, 2/4, 3/4, 4/4, 5/8, 6/8, 7/8, 8/8）の定義
    - SoundType enum（内蔵音声 Click、Wood、Beep とカスタム音声）の実装
    - 3 段階アクセントパターン（強拍、中拍、弱拍）の実装
    - _Requirements: 7.2, 7.6, 8.2, 8.3, 11.1, 11.2_

  - [x] 2.2 MetronomeState と GUI 状態モデルの実装

    - MetronomeState 構造体の拡張（拍子、音声設定、アクセント有効フラグ、音量を含む）
    - GuiState 構造体の実装（アクセント制御、音量制御を含む）
    - スレッドセーフな状態管理（Arc<Mutex<>>）の実装
    - _Requirements: 6.5, 7.5, 9.5, 10.4, 12.1, 12.5, 13.2, 13.3_

  - [x] 2.3 GUI 用エラー型の追加
    - GuiError、ConfigError の定義
    - 既存エラー型の拡張
    - _Requirements: 6.4, 8.4_

- [x] 3. アプリケーションランチャーとモード判定の実装

  - [x] 3.1 AppMode とモード判定ロジック

    - AppMode enum（Cli、Gui）の定義
    - コマンドライン引数の有無によるモード判定
    - _Requirements: 5.1, 5.3_

  - [x] 3.2 CLI 解析の更新
    - 既存の CLI 解析機能の保持
    - 引数なしの場合の None 返却対応
    - ヘルプメッセージに GUI モードの説明追加
    - _Requirements: 1.1, 1.2, 2.3_

- [x] 4. メトロノームコアロジックの拡張

  - [x] 4.1 拍子対応の Metronome 構造体の実装

    - 既存の Metronome 構造体を拡張
    - 拍子に基づく強拍・弱拍の管理
    - current_beat_in_measure の追跡
    - _Requirements: 7.3, 7.4, 10.3_

  - [x] 4.2 音声設定とスレッドセーフな制御

    - beat_sound と accent_sound の設定機能
    - Arc<Mutex<MetronomeState>>による状態管理
    - 非同期での start/stop 制御
    - _Requirements: 8.2, 8.3, 9.3, 9.4_

  - [x] 4.3 拍子別タイミング計算
    - 8 つの拍子での拍間隔計算
    - 強拍・中拍・弱拍判定ロジック
    - 複合拍子（5/8, 6/8, 7/8, 8/8）の適切なタイミング処理
    - _Requirements: 7.3, 7.4, 7.6, 11.2, 11.3_

- [x] 5. 音声エンジンの拡張

  - [x] 5.1 複数音声データとキャッシュシステム

    - 内蔵音声データ（Click、Wood、Beep）の実装
    - SoundData モデルとキャッシュシステム
    - 音声データのプリロード機能
    - _Requirements: 8.3, 8.5_

  - [x] 5.2 カスタム音声ファイル読み込み

    - WAV、MP3、OGG 形式のサポート
    - ファイル読み込みとバリデーション
    - エラー時の内蔵音声フォールバック
    - _Requirements: 8.4_

  - [x] 5.3 強拍・中拍・弱拍音声再生

    - beat_sound と accent_sound の区別再生
    - アクセント有効/無効制御
    - 音声タイプに基づく再生制御
    - _Requirements: 7.4, 8.2, 8.3, 12.2, 12.3_

  - [x] 5.4 音量制御対応音声再生
    - 音量レベル（0.0-1.0）に基づく音声再生
    - play_sound_with_volume メソッドの実装
    - AudioEngine での音量管理機能
    - 音量設定の Beat_Sound と Accent_Sound への適用
    - _Requirements: 13.3, 13.5_

- [x] 6. GUI エンジンの実装

  - [x] 6.1 MetronomeApp と eframe 統合

    - MetronomeApp 構造体の実装
    - eframe::App トレイトの実装
    - 基本的な GUI ウィンドウの表示
    - _Requirements: 5.1, 5.2, 5.4_

  - [x] 6.2 BPM 設定コントロール

    - BPM 入力フィールドの実装
    - BPM 増減ボタンの実装
    - リアルタイム入力バリデーション
    - _Requirements: 6.1, 6.2, 6.3, 6.4, 6.5_

  - [x] 6.3 拍子選択コントロール

    - 8 つの拍子選択ドロップダウンの実装
    - 現在の拍子表示
    - 小節あたりの拍数表示
    - _Requirements: 7.1, 7.2, 7.5, 11.1, 11.4_

  - [x] 6.4 音声選択コントロール

    - beat_sound 選択ドロップダウン
    - accent_sound 選択ドロップダウン
    - カスタム音声ファイル選択ダイアログ
    - サウンドテスト機能
    - _Requirements: 8.1, 8.2, 8.5, 8.7_

  - [x] 6.7 アクセント制御機能

    - アクセント有効/無効切り替えチェックボックス
    - アクセント設定の即座反映
    - アクセント状態の視覚的表示
    - _Requirements: 8.6, 12.1, 12.2, 12.3, 12.4, 12.5_

  - [x] 6.8 音量制御機能

    - 音量調節スライダーの実装
    - 音量レベル（0.0-1.0）のリアルタイム調整
    - 現在の音量レベルのパーセンテージ表示
    - 音量テスト機能（現在の音量レベルでサウンド再生）
    - 音量設定の永続化（設定ファイル保存・復元）
    - _Requirements: 13.1, 13.2, 13.3, 13.4, 13.6, 13.7_

  - [x] 6.5 スタート・ストップ制御

    - スタート・ストップボタンの実装
    - メトロノーム状態の視覚的表示
    - _Requirements: 9.1, 9.2, 9.3, 9.4_

  - [x] 6.6 状態表示とビートインジケーター

    - 現在の BPM、経過時間、拍数表示
    - 強拍・中拍・弱拍を区別する色分けされた視覚的ビートインジケーター
    - 小節内での拍進行状況の視覚的表示
    - 動作状態の表示
    - _Requirements: 9.5, 10.1, 10.2, 10.3, 10.4, 10.5, 10.6_

- [x] 7. CLI ディスプレイエンジンの拡張

  - [x] 7.1 強拍・中拍・弱拍対応の視覚的インジケーター

    - 既存の DisplayEngine を拡張
    - 強拍・中拍・弱拍の 3 段階区別表示
    - 拍子情報の表示
    - 色分けされたビートインジケーター
    - _Requirements: 3.4, 3.5, 3.6, 7.6, 11.2_

  - [x] 7.2 拡張された拍子記号サポート

    - 8 つの拍子記号（1/4, 2/4, 3/4, 4/4, 5/8, 6/8, 7/8, 8/8）の表示対応
    - 各拍子記号のビートパターン凡例
    - リアルタイムビート可視化
    - _Requirements: 11.1, 11.5_

- [x] 8. デュアルモードアプリケーションの統合

  - [x] 8.1 main 関数のモード分岐実装

    - モード判定に基づく CLI/GUI 起動
    - 共通初期化処理の実装
    - _Requirements: 5.1, 5.3_

  - [x] 8.2 CLI モードの実行フロー

    - 既存の CLI 機能の保持
    - 拡張されたメトロノームコアとの統合
    - _Requirements: 1.1, 1.5, 3.3_

  - [x] 8.3 GUI モードの実行フロー

    - eframe アプリケーションの起動
    - GUI 初期化エラーハンドリング
    - _Requirements: 5.1, 5.2, 5.4_

- [ ] 9. 音量制御機能のテストとドキュメント

  - [ ] 9.1 音量制御機能の単体テスト

    - 音量スライダーの動作テスト
    - 音量レベル設定と取得のテスト
    - 音量テスト機能のテスト
    - _Requirements: 13.1, 13.2, 13.3, 13.6_

  - [ ] 9.2 音量制御統合テスト

    - 音量設定の永続化テスト
    - 音量変更の即座反映テスト
    - Beat_Sound と Accent_Sound への音量適用テスト
    - _Requirements: 13.3, 13.5, 13.7_

  - [ ] 9.3 ドキュメント更新

    - README に音量制御機能の説明追加
    - GUI 機能セクションに音量スライダーの説明追加
    - 使用方法の更新
    - _Requirements: 13.1, 13.4, 13.6_
